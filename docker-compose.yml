version: '3.8'

networks:
  agrotrace-network:
    driver: bridge

services:
  # --- INFRASTRUCTURE DE DONNÉES ---
  timescaledb:
    image: timescale/timescaledb:latest-pg14
    container_name: agro_timescaledb
    environment:
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=adminpassword
      - POSTGRES_DB=agro_timeseries
    ports:
      - "5432:5432"
    networks:
      - agrotrace-network
    volumes:
      - timescaledb_data:/var/lib/postgresql/data

  postgis:
    image: postgis/postgis:14-3.3
    container_name: agro_postgis
    environment:
      - POSTGRES_PASSWORD=adminpassword 
      - POSTGRES_DB=agro_business
    ports:
      - "5435:5432"  # <--- ON CHANGE LE PORT ICI (5435 au lieu de 5433)
    networks:
      - agrotrace-network
    volumes:
      - postgis_new_data:/var/lib/postgresql/data # <--- NOUVEAU NOM DE VOLUME

  minio:
    image: minio/minio
    container_name: agro_minio
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    ports:
      - "9000:9000"
      - "9001:9001"
    networks:
      - agrotrace-network
    volumes:
      - minio_data:/data

  zookeeper:
    image: confluentinc/cp-zookeeper:7.3.0
    container_name: agro_zookeeper
    environment:
      - ZOOKEEPER_CLIENT_PORT=2181
      - ZOOKEEPER_TICK_TIME=2000
    networks:
      - agrotrace-network

  kafka:
    image: confluentinc/cp-kafka:7.3.0
    container_name: agro_kafka
    depends_on:
      - zookeeper
    ports:
      - "29092:29092"
    environment:
      - KAFKA_BROKER_ID=1
      - KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      - KAFKA_INTER_BROKER_LISTENER_NAME=PLAINTEXT
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
    networks:
      - agrotrace-network

  # --- MICROSERVICES AGROTRACE ---

  ingestion-api:
    build: 
      context: ./services/ingestion-capteurs
      dockerfile: Dockerfile
    container_name: agro_ingestion_api
    ports:
      - "8000:8000"
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - DB_HOST=timescaledb
      - DB_NAME=agro_timeseries
      - DB_USER=admin
      - DB_PASS=adminpassword
    networks:
      - agrotrace-network
    depends_on:
      - kafka
      - timescaledb

  ingestion-worker:
    build:
      context: ./services/ingestion-capteurs
      dockerfile: consumer/Dockerfile
    container_name: agro_ingestion_worker
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - DB_HOST=timescaledb
      - DB_NAME=agro_timeseries
      - DB_USER=admin
      - DB_PASS=adminpassword
    networks:
      - agrotrace-network
    depends_on:
      - kafka
      - timescaledb

  reco-irrigation:
    build:
      context: ./services/reco_irrigation
      dockerfile: Dockerfile
    container_name: agro_reco_irrigation
    ports:
      - "8002:8000"
    environment:
      # CORRECTION : On utilise l'utilisateur postgres car admin a échoué tout à l'heure
      - DATABASE_URL=postgresql://postgres:adminpassword@agro_postgis:5432/agro_business
    networks:
      - agrotrace-network
    depends_on:
      - postgis

  vision-plante:
    build:
      context: ./services/vision_plante
      dockerfile: Dockerfile
    container_name: agro_vision_plante
    ports:
      - "8001:8000"
    networks:
      - agrotrace-network
    volumes:
      - ./services/vision_plante/models:/app/models
    depends_on:
      - minio

  prevision-eau:
    build:
      context: ./services/prevision_eau
      dockerfile: Dockerfile
    container_name: agro_prevision_eau
    environment:
      - DB_HOST=timescaledb
      - DB_NAME=agro_timeseries
      - DB_USER=admin
      - DB_PASS=adminpassword
    networks:
      - agrotrace-network
    depends_on:
      - timescaledb

  regles-agro:
    build:
      context: ./services/regles-agro
      dockerfile: Dockerfile
    container_name: agro_regles
    ports:
      - "8083:8081"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://agro_postgis:5432/agro_business
      # ON CHANGE L'UTILISATEUR ICI :
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=adminpassword
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update
    networks:
      - agrotrace-network
    depends_on:
      - postgis

  pretraitement:
    build:
      context: ./services/pretraitement
      dockerfile: Dockerfile
    container_name: agro_pretraitement
    ports:
      - "8004:8001"
    environment:
      - TIMESCALE_HOST=timescaledb
      - TIMESCALE_PORT=5432
      - TIMESCALE_USER=admin
      - TIMESCALE_PASSWORD=adminpassword
      - TIMESCALE_DB=agro_timeseries
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
      - MINIO_SECURE=False
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    networks:
      - agrotrace-network
    depends_on:
      - timescaledb
      - minio
      - kafka

  dashboard-sig:
    build:
      context: ./services/dashboard-sig
      dockerfile: Dockerfile
    container_name: agro_dashboard
    # Suppression du port 3000:80 pour laisser Nginx gérer le port 80
    networks:
      - agrotrace-network

  # --- GATEWAY NGINX ---
  nginx:
    image: nginx:latest
    container_name: agro_nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - agrotrace-network
    depends_on:
      - reco-irrigation
      - dashboard-sig

volumes:
  timescaledb_data:
  postgis_data:
  postgis_new_data:
  minio_data: